<!DOCTYPE html>
<html lang="ja">

<head>
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="google-site-verification" content="3rckRvHECynAe2w8OLIitJ65VhT8SjqYBJApRsXwBPs" />

  <title>AIcomment | è‡ªåˆ†ã®æ–‡ä½“ã‚’å†ç¾ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆãƒ»ãƒªã‚¢ãºä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
  <meta name="description" content="ç‹¬è‡ªã®AIã‚¨ãƒ³ã‚¸ãƒ³ã€ŒMy Styleã€ãŒã‚ãªãŸã®æ–‡ç« ã®ç™–ã‚’å­¦ç¿’ã—ã€è‡ªç„¶ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼ã‚’çˆ†é€Ÿã§ä½œæˆã€‚æ¶ç©ºã®è«–æ–‡å¼•ç”¨ã‚’é˜²æ­¢ã™ã‚‹èª å®Ÿãªè¨­è¨ˆã§ã€æ—¥ã€…ã®èª²é¡Œæå‡ºã‚’ã‚¹ãƒãƒ¼ãƒˆã«ã‚µãƒãƒ¼ãƒˆã€‚">
  <meta name="keywords" content="ãƒªã‚¢ãº, ãƒ¬ãƒãƒ¼ãƒˆ, å¤§å­¦, ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼, ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼ AI, æ–‡ç« ä½œæˆ, è‡ªå‹•ç”Ÿæˆ, ãƒªã‚¢ãº ä»£è¡Œ, ãƒªã‚¢ãº ãƒã‚¿åˆ‡ã‚Œ, ãƒªã‚¢ãº çˆ†é€Ÿ, My Style">

  <meta property="og:title" content="AIcomment | ã‚ãªãŸã®ç­†è‡´ã‚’å†ç¾ã™ã‚‹å”¯ä¸€ã®ãƒªã‚¢ãºæ”¯æ´AI">
  <meta property="og:description" content="ã€ŒAIã£ã½ã•ã€ã¯ã‚‚ã†å’æ¥­ã€‚è‡ªåˆ†ã®æ–‡ä½“ã‚’å­¦ç¿’ã•ã›ã¦ã€è‡ªç„¶ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼ã‚’ã‚µã‚¯ãƒƒã¨å®Œæˆã€‚">
  <meta property="og:url" content="https://aicomment-paper.vercel.app">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://aicomment-paper.vercel.app/ogp-image.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://aicomment-paper.vercel.app/">
  <meta name="robots" content="index, follow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* ============================================
       DESIGN SYSTEM â€” Clean & White
       ============================================ */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #F9FAFB;
      --card: #FFFFFF;
      --text: #374151;
      --text-light: #6B7280;
      --text-muted: #9CA3AF;
      --accent: #3B82F6;
      --accent-hover: #2563EB;
      --accent-light: #DBEAFE;
      --accent-ultra-light: #EFF6FF;
      --border: #E5E7EB;
      --border-focus: #93C5FD;
      --success: #10B981;
      --success-light: #D1FAE5;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: 0.2s ease;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
      font-weight: 400;
      min-height: 100vh;
    }

    /* ============================================
       HEADER
       ============================================ */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-inner {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #818CF8);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .logo-text span {
      color: var(--accent);
    }

    .header-badge {
      font-size: 11px;
      font-weight: 500;
      color: var(--accent);
      background: var(--accent-light);
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.02em;
    }

    /* ============================================
       MAIN LAYOUT â€” 2-Column Grid
       ============================================ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px 80px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
    }

    .col-left {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .col-right {
      position: sticky;
      top: 100px;
    }

    .gen-btn-wrap {
      margin-bottom: 0;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .col-right {
        position: static;
      }
    }

    /* ============================================
       MODALS
       ============================================ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-box {
      background: var(--card);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 90%;
      box-shadow: var(--shadow-lg);
      text-align: center;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .modal-box h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .modal-box p {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .btn-google {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      color: var(--text);
    }

    .btn-google:hover {
      box-shadow: var(--shadow-md);
      border-color: #93C5FD;
    }

    .btn-ad {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #3B82F6, #2563EB);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }

    .btn-ad:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-ad:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .ad-countdown {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 12px;
    }

    .modal-skip {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 16px;
      cursor: pointer;
      text-decoration: underline;
    }

    .modal-skip:hover {
      color: var(--accent);
    }

    .premium-banner {
      background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
      border: 1px solid #BFDBFE;
      border-radius: var(--radius-sm);
      padding: 14px 18px;
      margin-top: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
      line-height: 1.5;
    }

    .premium-banner .badge-pro {
      background: linear-gradient(135deg, #3B82F6, #8B5CF6);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .user-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .user-name {
      font-size: 12px;
      color: var(--text-light);
    }

    /* ============================================
       CARD COMPONENT
       ============================================ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: box-shadow var(--transition);
      animation: fadeUp 0.5s ease both;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .card:nth-child(2) {
      animation-delay: 0.08s;
    }

    .card:nth-child(3) {
      animation-delay: 0.16s;
    }

    .card:nth-child(4) {
      animation-delay: 0.24s;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .card-icon.style {
      background: #EDE9FE;
    }

    .card-icon.lecture {
      background: var(--accent-ultra-light);
    }

    .card-icon.adjust {
      background: #FEF3C7;
    }

    .card-icon.result {
      background: var(--success-light);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: 1px;
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
    }

    textarea,
    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--bg);
      transition: border-color var(--transition), box-shadow var(--transition);
      outline: none;
      line-height: 1.6;
    }

    textarea:focus,
    input[type="text"]:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    textarea::placeholder,
    input::placeholder {
      color: var(--text-muted);
    }

    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      color: var(--text);
      background: var(--bg);
      outline: none;
      cursor: pointer;
      transition: border-color var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    select:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      outline: none;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.15);
      opacity: 0;
      transition: opacity var(--transition);
    }

    .btn:hover::after {
      opacity: 1;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 2px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #F3F4F6;
      border-color: #D1D5DB;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-lg {
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 600;
      border-radius: var(--radius);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-full {
      width: 100%;
    }

    /* ============================================
       STYLE ANALYSIS â€” My Style
       ============================================ */
    .style-saved-banner {
      display: none;
      align-items: center;
      gap: 8px;
      background: var(--success-light);
      color: #065F46;
      border: 1px solid #A7F3D0;
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
      animation: fadeUp 0.3s ease;
    }

    .style-saved-banner.show {
      display: flex;
    }

    .style-stats {
      display: none;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 16px;
    }

    .style-stats.show {
      display: grid;
    }

    .stat-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .style-patterns {
      display: none;
      margin-top: 12px;
      padding: 12px 16px;
      background: var(--accent-ultra-light);
      border: 1px solid var(--accent-light);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-light);
    }

    .style-patterns.show {
      display: block;
    }

    .style-patterns strong {
      color: var(--text);
    }

    .reset-style-btn {
      display: none;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      background: none;
      border: none;
      text-decoration: underline;
    }

    .reset-style-btn.show {
      display: inline-block;
    }

    /* ============================================
       PDF UPLOAD
       ============================================ */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition);
      margin-top: 12px;
      position: relative;
    }

    .upload-area:hover {
      border-color: var(--accent);
      background: var(--accent-ultra-light);
    }

    .upload-area.dragover {
      border-color: var(--accent);
      background: var(--accent-ultra-light);
    }

    .upload-area .upload-icon {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .upload-area .upload-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    .upload-area .upload-text strong {
      color: var(--accent);
    }

    .upload-area input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-name-display {
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 13px;
      color: var(--success);
      font-weight: 500;
    }

    .file-name-display.show {
      display: flex;
    }

    .upload-formats {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .file-loading {
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    .file-loading.show {
      display: flex;
    }

    .or-divider {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      margin: 14px 0;
      position: relative;
    }

    .or-divider::before,
    .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: calc(50% - 20px);
      height: 1px;
      background: var(--border);
    }

    .or-divider::before {
      left: 0;
    }

    .or-divider::after {
      right: 0;
    }

    /* ============================================
       QUALITY SLIDER
       ============================================ */
    .slider-container {
      padding: 4px 0;
    }

    .slider-track {
      position: relative;
      margin: 20px 0 12px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #DBEAFE, var(--accent));
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      border: 3px solid #fff;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.35);
      cursor: pointer;
      transition: box-shadow var(--transition), transform var(--transition);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      box-shadow: 0 2px 10px rgba(59, 130, 246, 0.5);
      transform: scale(1.1);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }

    .slider-label {
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
      transition: all var(--transition);
      text-align: center;
      flex: 1;
    }

    .slider-label:hover {
      color: var(--accent);
    }

    .slider-label.active {
      color: var(--accent);
      font-weight: 600;
    }

    .slider-current {
      text-align: center;
      margin-bottom: 4px;
    }

    .slider-current .level-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      padding: 4px 14px;
      border-radius: 20px;
    }

    .dept-select {
      margin-top: 20px;
    }

    /* ============================================
       RESULT AREA
       ============================================ */
    .result-card {
      display: block;
    }

    .result-text {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      font-size: 14px;
      line-height: 1.9;
      color: var(--text);
      min-height: 100px;
      white-space: pre-wrap;
    }

    .result-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .copy-feedback {
      display: none;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--success);
      font-weight: 500;
      margin-top: 10px;
      animation: fadeUp 0.3s ease;
    }

    .copy-feedback.show {
      display: flex;
    }

    /* ============================================
       LOADING SPINNER
       ============================================ */
    .loading {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 32px 0;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (max-width: 600px) {
      .container {
        padding: 16px 16px 60px;
      }

      .card {
        padding: 20px;
      }

      .style-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .stat-item {
        padding: 8px;
      }

      .stat-value {
        font-size: 16px;
      }

      .result-actions {
        flex-direction: column;
      }

      .header-inner {
        padding: 0 16px;
      }
    }

    /* ============================================
       UTILITY
       ============================================ */
    .mt-12 {
      margin-top: 12px;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>

  <!-- ========== HEADER ========== -->
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">ğŸ“</div>
        <div class="logo-text">AI<span>ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼</span></div>
      </div>
      <div class="user-bar" id="user-bar">
        <div class="header-badge">å­¦ç¿’æ”¯æ´ãƒ„ãƒ¼ãƒ«</div>
      </div>
    </div>
  </header>

  <!-- ========== MAIN ========== -->
  <main class="container">
    <div class="main-grid">
      <div class="col-left">

        <!-- ===== SECTION 1: My Style ===== -->
        <section class="card" id="style-section">
          <div class="card-header">
            <div class="card-icon style">âœï¸</div>
            <div>
              <div class="card-title">æ–‡ä½“åŒæœŸï¼ˆMy Styleï¼‰</div>
              <div class="card-subtitle">ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã«ã‚ˆã‚Šã€å‰å›ã®æ–‡è„ˆã‚’ç¶­æŒã€‚ç²¾åº¦ãŒæ ¼æ®µã«å‘ä¸Šã—ã¾ã™</div>
            </div>
          </div>

          <div class="style-saved-banner" id="style-banner">
            âœ… æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™
          </div>

          <div id="style-input-area">
            <label for="style-text">éå»ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚’è²¼ã‚Šä»˜ã‘</label>
            <textarea id="style-text"
              placeholder="ã“ã“ã«éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚„ã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼ã®æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚&#10;èªå°¾ã®ç™–ã‚„æ¼¢å­—ã®ä½¿ã„æ–¹ã€æ–‡ç« ã®ãƒªã‚ºãƒ ã‚’è§£æã—ã¾ã™ã€‚"></textarea>
            <button class="btn btn-primary mt-16" id="analyze-btn" onclick="analyzeStyle()">
              ğŸ” æ–‡ä½“ã‚’è§£æãƒ»åŒæœŸ
            </button>
          </div>

          <div class="style-stats" id="style-stats">
            <div class="stat-item">
              <div class="stat-value" id="stat-kanji">â€”</div>
              <div class="stat-label">æ¼¢å­—ç‡</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-avg-len">â€”</div>
              <div class="stat-label">å¹³å‡æ–‡é•·</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-endings">â€”</div>
              <div class="stat-label">èªå°¾ã‚¿ã‚¤ãƒ—</div>
            </div>
          </div>

          <div class="style-patterns" id="style-patterns"></div>

          <button class="reset-style-btn" id="reset-style-btn" onclick="resetStyle()">
            æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
          </button>
        </section>

        <!-- ===== SECTION 2: è¬›ç¾©ã‚½ãƒ¼ã‚¹ ===== -->
        <section class="card" id="lecture-section">
          <div class="card-header">
            <div class="card-icon lecture">ğŸ“–</div>
            <div>
              <div class="card-title">è¬›ç¾©ã‚½ãƒ¼ã‚¹å…¥åŠ›</div>
              <div class="card-subtitle">è¬›ç¾©åã¨ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>
          </div>

          <label for="lecture-name">è¬›ç¾©å</label>
          <input type="text" id="lecture-name" placeholder="ä¾‹ï¼šç¤¾ä¼šå­¦æ¦‚è«–ã€ãƒ¡ãƒ‡ã‚£ã‚¢è«–â…¡">

          <div class="mt-16">
            <label for="resume-text">ãƒ¬ã‚¸ãƒ¥ãƒ¡å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼‰</label>
            <textarea id="resume-text" placeholder="ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ä¸‹ã®æ¬„ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"></textarea>
          </div>

          <div class="or-divider">ã¾ãŸã¯</div>

          <div class="upload-area" id="upload-area">
            <input type="file" accept=".pdf,.docx,.pptx" id="file-input" onchange="handleFileUpload(event)">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text"><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
            <div class="upload-formats">å¯¾å¿œå½¢å¼ï¼šPDF, Word (.docx), PowerPoint (.pptx)</div>
          </div>
          <div class="file-name-display" id="file-name-display">
            ğŸ“ <span id="file-name-text"></span>
          </div>
          <div class="file-loading" id="file-loading">
            <div class="spinner" style="width:18px;height:18px;border-width:2px;"></div>
            <span>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...</span>
          </div>
        </section>

        <!-- ===== SECTION 3: èª¿æ•´ãƒ‘ãƒãƒ« ===== -->
        <section class="card" id="adjust-section">
          <div class="card-header">
            <div class="card-icon adjust">ğŸ›ï¸</div>
            <div>
              <div class="card-title">èª¿æ•´ãƒ‘ãƒãƒ«</div>
              <div class="card-subtitle">ç”Ÿæˆã™ã‚‹æ–‡ç« ã®ãƒ¬ãƒ™ãƒ«ã¨ãƒˆãƒ¼ãƒ³ã‚’è¨­å®š</div>
            </div>
          </div>

          <div class="slider-container">
            <label>å¯¾è±¡ãƒ¬ãƒ™ãƒ«</label>
            <div class="slider-current">
              <span class="level-badge" id="level-badge">50% â€” å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰</span>
            </div>
            <div class="slider-track">
              <input type="range" id="quality-slider" min="1" max="5" value="3" step="1"
                oninput="updateSlider(this.value)">
            </div>
            <div class="slider-labels">
              <span class="slider-label" onclick="setSlider(1)">10%<br>ä¸­å­¦ç”Ÿ</span>
              <span class="slider-label" onclick="setSlider(2)">30%<br>é«˜æ ¡ç”Ÿ</span>
              <span class="slider-label active" onclick="setSlider(3)">50%<br>å¤§å­¦ç”Ÿ</span>
              <span class="slider-label" onclick="setSlider(4)">70%<br>çœŸé¢ç›®</span>
              <span class="slider-label" onclick="setSlider(5)">90%<br>å¤§å­¦é™¢</span>
            </div>
          </div>

          <div class="dept-select">
            <label for="dept-filter">å­¦éƒ¨ãƒˆãƒ¼ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
            <select id="dept-filter">
              <option value="none">ãªã—</option>
              <option value="science-eng">ç†ç³»ãƒ»å·¥å­¦éƒ¨</option>
              <option value="social-psych">ç¤¾ä¼šãƒ»å¿ƒç†å­¦éƒ¨</option>
              <option value="econ-biz">çµŒæ¸ˆãƒ»çµŒå–¶å­¦éƒ¨</option>
              <option value="literature-phil">æ–‡å­¦ãƒ»å“²å­¦éƒ¨</option>
            </select>
          </div>
        </section>

        <!-- ===== GENERATE BUTTON ===== -->
        <div class="gen-btn-wrap">
          <button class="btn btn-primary btn-lg btn-full" id="generate-btn" onclick="handleGenerate()">
            ğŸš€ ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸‹æ›¸ãï¼‰ã‚’ç”Ÿæˆ
          </button>
        </div>

      </div><!-- /col-left -->
      <div class="col-right">

        <!-- ===== SECTION 4: ç”Ÿæˆçµæœ ===== -->
        <section class="card result-card" id="result-section">
          <div class="card-header">
            <div class="card-icon result">âœ¨</div>
            <div>
              <div class="card-title">ç”Ÿæˆçµæœ</div>
              <div class="card-subtitle">ã‚ãªãŸã®æ–‡ä½“ã§ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ãƒ‘ãƒ¼</div>
            </div>
          </div>

          <div id="result-empty" class="result-text"
            style="text-align:center; color: var(--text-muted); padding: 40px 20px;">
            âœ¨ ã“ã“ã«ç”ŸæˆçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">ã‚ãªãŸã®æ–‡ä½“ã§ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™â€¦</div>
          </div>

          <div id="result-content" class="hidden">
            <div class="result-text" id="result-text"></div>
            <div class="result-actions">
              <button class="btn btn-success" onclick="copyResult()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
              <button class="btn btn-secondary" onclick="generatePaper()">ğŸ”„ å†ç”Ÿæˆ</button>
            </div>
            <div class="copy-feedback" id="copy-feedback">
              âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ
            </div>
          </div>
          <div class="premium-banner" id="premium-banner">
            <span class="badge-pro">PRO</span>
            <span>åºƒå‘Šãªã—ãƒ»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆãƒ»é«˜ç²¾åº¦AIã§ã€ã•ã‚‰ã«å¿«é©ãªä½œæˆä½“é¨“ã‚’ã€‚</span>
          </div>
        </section>

      </div><!-- /col-right -->
    </div><!-- /main-grid -->
  </main>

  <!-- ========== MODALS ========== -->
  <div class="modal-overlay" id="login-modal">
    <div class="modal-box">
      <div class="modal-icon">ğŸ”</div>
      <h3>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç¶™ç¶šåˆ©ç”¨</h3>
      <p>æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ç²¾åº¦å‘ä¸Šã®ãŸã‚ã«ã€<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
      <button class="btn-google" onclick="mockLogin()">
        <svg width="20" height="20" viewBox="0 0 48 48">
          <path fill="#4285F4"
            d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
          <path fill="#34A853"
            d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
          <path fill="#FBBC05"
            d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" />
          <path fill="#EA4335"
            d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
        </svg>
        Googleã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>
    </div>
  </div>

  <div class="modal-overlay" id="ad-modal">
    <div class="modal-box">
      <div class="modal-icon">ğŸ¬</div>
      <h3>åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ</h3>
      <p>åºƒå‘Šã®è¦–è´å¾Œã€è‡ªå‹•çš„ã«ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚<br>åºƒå‘Šãªã—ã§åˆ©ç”¨ã™ã‚‹ã«ã¯ã€PROãƒ—ãƒ©ãƒ³ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚</p>
      <button class="btn-ad" id="ad-watch-btn" onclick="watchAd()">
        â–¶ï¸ åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ
      </button>
      <div class="ad-countdown" id="ad-countdown"></div>
    </div>
  </div>

  <!-- ========== JAVASCRIPT ========== -->
  <script>
    /* ============================================
       STATE
       ============================================ */
    let styleData = null;
    let usageCount = parseInt(localStorage.getItem('ac_usageCount') || '0');
    let isLoggedIn = localStorage.getItem('ac_loggedIn') === 'true';
    let userTier = localStorage.getItem('ac_userTier') || 'free'; // free | premium

    /* ============================================
       3-STAGE UX GATE
       ============================================ */
    function handleGenerate() {
      const lectureName = document.getElementById('lecture-name').value.trim();
      const resumeText = document.getElementById('resume-text').value.trim();
      if (!lectureName) { alert('è¬›ç¾©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      if (!resumeText) { alert('ãƒ¬ã‚¸ãƒ¥ãƒ¡ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

      // Stage 1: Free trial (1st & 2nd use) â€” no gates
      if (usageCount < 2) {
        proceedGeneration();
        return;
      }
      // Stage 2: Require login from 3rd use
      if (!isLoggedIn) {
        document.getElementById('login-modal').classList.add('show');
        return;
      }
      // Stage 3: Show ad (unless premium)
      if (userTier !== 'premium') {
        document.getElementById('ad-modal').classList.add('show');
        return;
      }
      // Premium â€” straight through
      proceedGeneration();
    }

    function proceedGeneration() {
      usageCount++;
      localStorage.setItem('ac_usageCount', usageCount);
      generatePaper();
    }

    function mockLogin() {
      isLoggedIn = true;
      localStorage.setItem('ac_loggedIn', 'true');
      document.getElementById('login-modal').classList.remove('show');
      updateHeaderUser();
      // After login, show ad modal
      if (userTier !== 'premium') {
        setTimeout(() => {
          document.getElementById('ad-modal').classList.add('show');
        }, 300);
      } else {
        proceedGeneration();
      }
    }

    function watchAd() {
      const btn = document.getElementById('ad-watch-btn');
      const cdEl = document.getElementById('ad-countdown');
      btn.disabled = true;
      btn.textContent = 'â³ è¦–è´ä¸­...';
      let sec = 5;
      cdEl.textContent = `ã‚ã¨ ${sec} ç§’...`;
      const timer = setInterval(() => {
        sec--;
        if (sec <= 0) {
          clearInterval(timer);
          cdEl.textContent = '';
          btn.disabled = false;
          btn.innerHTML = 'â–¶ï¸ åºƒå‘Šã‚’è¦–è´ã—ã¦ç”Ÿæˆ';
          document.getElementById('ad-modal').classList.remove('show');
          proceedGeneration();
        } else {
          cdEl.textContent = `ã‚ã¨ ${sec} ç§’...`;
        }
      }, 1000);
    }

    function updateHeaderUser() {
      const bar = document.getElementById('user-bar');
      if (isLoggedIn) {
        bar.innerHTML = `
          <div class="user-avatar">ğŸ‘¤</div>
          <span class="user-name">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</span>
          <div class="header-badge">å­¦ç¿’æ”¯æ´ãƒ„ãƒ¼ãƒ«</div>
        `;
      }
    }

    const BANNED_WORDS = [
      'è¦ç´„ã™ã‚‹ã¨', 'ã¾ã¨ã‚ã¨ã—ã¦', 'ç·ã˜ã¦',
      'ä¸€è€ƒã®ä¾¡å€¤ãŒã‚ã‚‹', 'æœ¬è¬›ç¾©ã¯', 'éå¸¸ã«é‡è¦', 'ç‰¹ç­†ã™ã¹ã'
    ];

    const LEVEL_MAP = {
      1: { pct: '10%', label: 'ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«', desc: '10% â€” ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«' },
      2: { pct: '30%', label: 'é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«', desc: '30% â€” é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«' },
      3: { pct: '50%', label: 'å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰', desc: '50% â€” å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰' },
      4: { pct: '70%', label: 'å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰', desc: '70% â€” å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰' },
      5: { pct: '90%', label: 'å¤§å­¦é™¢ãƒ»è«–æ–‡', desc: '90% â€” å¤§å­¦é™¢ãƒ»è«–æ–‡ãƒ¬ãƒ™ãƒ«' },
    };

    /* ============================================
       INIT
       ============================================ */
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('commentPaper_styleData');
      if (saved) {
        styleData = JSON.parse(saved);
        showStyleResults(styleData);
        showSavedBanner();
      }
      updateHeaderUser();
      initFileInput();

      // Drag & drop
      const uploadArea = document.getElementById('upload-area');
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 1 && userTier !== 'premium') {
          alert('ã‚¨ãƒ©ãƒ¼ï¼š1ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\n\nâ€»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«èª­ã¿è¾¼ã‚“ã§è§£æã—ãŸã„å ´åˆã¯ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        if (files.length > 0) {
          processFile(files[0]);
        }
      });
    });

    /* ============================================
       STYLE ANALYSIS
       ============================================ */
    function analyzeStyle() {
      const text = document.getElementById('style-text').value.trim();
      if (!text || text.length < 20) {
        alert('è§£æã™ã‚‹ã«ã¯20æ–‡å­—ä»¥ä¸Šã®æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // Kanji ratio
      const kanjiCount = (text.match(/[\u4E00-\u9FFF]/g) || []).length;
      const kanjiRatio = Math.round((kanjiCount / text.length) * 100);

      // Sentence analysis
      const sentences = text.split(/[ã€‚ï¼ï¼Ÿ\n]+/).filter(s => s.trim().length > 0);
      const avgLength = Math.round(sentences.reduce((a, s) => a + s.length, 0) / sentences.length);

      // Endings analysis
      const endings = {};
      const endingPatterns = [
        { pattern: /ã ã¨æ€ã†/, label: 'ã€œã ã¨æ€ã†' },
        { pattern: /ã¨æ€ã†/, label: 'ã€œã¨æ€ã†' },
        { pattern: /ã¨æ€ã£ãŸ/, label: 'ã€œã¨æ€ã£ãŸ' },
        { pattern: /ã¨æ„Ÿã˜ãŸ/, label: 'ã€œã¨æ„Ÿã˜ãŸ' },
        { pattern: /ã¨æ„Ÿã˜ã‚‹/, label: 'ã€œã¨æ„Ÿã˜ã‚‹' },
        { pattern: /ã§ã¯ãªã„ã ã‚ã†ã‹/, label: 'ã€œã§ã¯ãªã„ã ã‚ã†ã‹' },
        { pattern: /ã§ã¯ãªã„ã‹/, label: 'ã€œã§ã¯ãªã„ã‹' },
        { pattern: /ã§ã‚ã‚‹/, label: 'ã€œã§ã‚ã‚‹' },
        { pattern: /ã®ã /, label: 'ã€œã®ã ' },
        { pattern: /ã®ã§ã‚ã‚‹/, label: 'ã€œã®ã§ã‚ã‚‹' },
        { pattern: /ã ã£ãŸ/, label: 'ã€œã ã£ãŸ' },
        { pattern: /ã¾ã—ãŸ/, label: 'ã€œã¾ã—ãŸ' },
        { pattern: /ã§ã™/, label: 'ã€œã§ã™' },
        { pattern: /ã¾ã™/, label: 'ã€œã¾ã™' },
        { pattern: /ã ã¨è€ƒãˆã‚‹/, label: 'ã€œã ã¨è€ƒãˆã‚‹' },
        { pattern: /ãŸã„/, label: 'ã€œãŸã„' },
        { pattern: /ã‹ã‚‚ã—ã‚Œãªã„/, label: 'ã€œã‹ã‚‚ã—ã‚Œãªã„' },
        { pattern: /ã¨è¨€ãˆã‚‹/, label: 'ã€œã¨è¨€ãˆã‚‹' },
      ];

      sentences.forEach(s => {
        const trimmed = s.trim();
        endingPatterns.forEach(ep => {
          if (ep.pattern.test(trimmed)) {
            endings[ep.label] = (endings[ep.label] || 0) + 1;
          }
        });
      });

      const topEndings = Object.entries(endings)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(e => e[0]);

      // Determine style type
      const hasDa = topEndings.some(e => e.includes('ã§ã‚ã‚‹') || e.includes('ã®ã '));
      const hasDesu = topEndings.some(e => e.includes('ã§ã™') || e.includes('ã¾ã™'));
      let styleType = 'æ··åœ¨å‹';
      if (hasDa && !hasDesu) styleType = 'ã ãƒ»ã§ã‚ã‚‹èª¿';
      else if (hasDesu && !hasDa) styleType = 'ã§ã™ãƒ»ã¾ã™èª¿';

      // Frequent expressions
      const freqExpressions = [];
      const exprPatterns = [
        /ã—ã‹ã—/g, /ä¸€æ–¹ã§/g, /ã¾ãŸ/g, /ãã®ãŸã‚/g, /ã¤ã¾ã‚Š/g,
        /ä¾‹ãˆã°/g, /ãªãœãªã‚‰/g, /ãã‚Œã‚†ãˆ/g, /ã™ãªã‚ã¡/g,
        /ç¢ºã‹ã«/g, /ã‚€ã—ã‚/g, /ãŸã ã—/g, /ç‰¹ã«/g, /å®Ÿéš›ã«/g
      ];
      exprPatterns.forEach(p => {
        const m = text.match(p);
        if (m && m.length >= 1) {
          freqExpressions.push(p.source);
        }
      });

      // Hiragana ratio
      const hiraganaCount = (text.match(/[\u3040-\u309F]/g) || []).length;
      const hiraganaRatio = Math.round((hiraganaCount / text.length) * 100);

      styleData = {
        kanjiRatio,
        hiraganaRatio,
        avgLength,
        styleType,
        topEndings,
        freqExpressions,
        sampleText: text.substring(0, 500),
        sentenceCount: sentences.length,
      };

      localStorage.setItem('commentPaper_styleData', JSON.stringify(styleData));
      showStyleResults(styleData);
      showSavedBanner();
    }

    function showStyleResults(data) {
      document.getElementById('stat-kanji').textContent = data.kanjiRatio + '%';
      document.getElementById('stat-avg-len').textContent = data.avgLength + 'å­—';
      document.getElementById('stat-endings').textContent = data.styleType;

      const patternsEl = document.getElementById('style-patterns');
      let patternsHTML = '<strong>æ¤œå‡ºã•ã‚ŒãŸèªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š</strong> ' + (data.topEndings.join('ã€') || 'ãªã—');
      if (data.freqExpressions.length > 0) {
        patternsHTML += '<br><strong>é »å‡ºè¡¨ç¾ï¼š</strong> ' + data.freqExpressions.join('ã€');
      }
      patternsEl.innerHTML = patternsHTML;

      document.getElementById('style-stats').classList.add('show');
      patternsEl.classList.add('show');
      document.getElementById('reset-style-btn').classList.add('show');
    }

    function showSavedBanner() {
      document.getElementById('style-banner').classList.add('show');
    }

    function resetStyle() {
      if (!confirm('æ–‡ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      localStorage.removeItem('commentPaper_styleData');
      styleData = null;
      document.getElementById('style-banner').classList.remove('show');
      document.getElementById('style-stats').classList.remove('show');
      document.getElementById('style-patterns').classList.remove('show');
      document.getElementById('reset-style-btn').classList.remove('show');
      document.getElementById('style-text').value = '';
    }

    /* ============================================
       FILE HANDLING (PDF / Word / PPT)
       ============================================ */
    function initFileInput() {
      const fileInput = document.getElementById('file-input');
      if (userTier === 'premium') {
        fileInput.setAttribute('multiple', '');
      } else {
        fileInput.removeAttribute('multiple');
      }
    }

    function handleFileUpload(event) {
      const files = event.target.files;
      if (files.length > 1 && userTier !== 'premium') {
        alert('ã‚¨ãƒ©ãƒ¼ï¼š1ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\n\nâ€»è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«èª­ã¿è¾¼ã‚“ã§è§£æã—ãŸã„å ´åˆã¯ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        event.target.value = '';
        return;
      }
      if (files[0]) processFile(files[0]);
    }

    async function processFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      const supported = ['pdf', 'docx', 'pptx'];
      if (!supported.includes(ext)) {
        alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚PDF, Word (.docx), PowerPoint (.pptx) ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        return;
      }

      // Show file name & loading
      document.getElementById('file-name-text').textContent = file.name;
      document.getElementById('file-name-display').classList.add('show');
      document.getElementById('file-loading').classList.add('show');

      try {
        let fullText = '';
        const arrayBuffer = await file.arrayBuffer();

        if (ext === 'pdf') {
          fullText = await extractPDF(arrayBuffer);
        } else if (ext === 'docx') {
          fullText = await extractWord(arrayBuffer);
        } else if (ext === 'pptx') {
          fullText = await extractPPTX(arrayBuffer);
        }

        document.getElementById('resume-text').value = fullText.trim();
      } catch (err) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      } finally {
        document.getElementById('file-loading').classList.remove('show');
      }
    }

    async function extractPDF(arrayBuffer) {
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join(' ') + '\n';
      }
      return fullText;
    }

    async function extractWord(arrayBuffer) {
      const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
      return result.value;
    }

    async function extractPPTX(arrayBuffer) {
      const zip = await JSZip.loadAsync(arrayBuffer);
      let allText = '';
      // Iterate through slide XML files
      const slideFiles = Object.keys(zip.files)
        .filter(name => /^ppt\/slides\/slide\d+\.xml$/.test(name))
        .sort((a, b) => {
          const numA = parseInt(a.match(/slide(\d+)/)[1]);
          const numB = parseInt(b.match(/slide(\d+)/)[1]);
          return numA - numB;
        });

      for (const slidePath of slideFiles) {
        const xmlStr = await zip.files[slidePath].async('string');
        // Parse XML and extract text nodes (<a:t> tags)
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlStr, 'application/xml');
        const textNodes = xmlDoc.getElementsByTagNameNS('http://schemas.openxmlformats.org/drawingml/2006/main', 't');
        const slideTexts = [];
        for (let i = 0; i < textNodes.length; i++) {
          const t = textNodes[i].textContent.trim();
          if (t) slideTexts.push(t);
        }
        if (slideTexts.length > 0) {
          allText += slideTexts.join(' ') + '\n';
        }
      }
      return allText;
    }

    /* ============================================
       SLIDER
       ============================================ */
    function updateSlider(val) {
      val = parseInt(val);
      document.getElementById('level-badge').textContent = LEVEL_MAP[val].desc;

      document.querySelectorAll('.slider-label').forEach((el, i) => {
        el.classList.toggle('active', i === val - 1);
      });
    }

    function setSlider(val) {
      document.getElementById('quality-slider').value = val;
      updateSlider(val);
    }

    /* ============================================
       GENERATION LOGIC
       ============================================ */
    function generatePaper() {
      const lectureName = document.getElementById('lecture-name').value.trim();
      const resumeText = document.getElementById('resume-text').value.trim();

      const level = parseInt(document.getElementById('quality-slider').value);
      const dept = document.getElementById('dept-filter').value;

      // Show result section with loading
      const resultSection = document.getElementById('result-section');
      document.getElementById('result-empty').style.display = 'none';
      document.getElementById('loading').classList.add('show');
      document.getElementById('result-content').classList.add('hidden');
      document.getElementById('copy-feedback').classList.remove('show');

      // Scroll to result
      resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Simulate generation delay
      setTimeout(() => {
        const generated = buildCommentPaper(lectureName, resumeText, level, dept);
        document.getElementById('result-text').textContent = generated;
        document.getElementById('loading').classList.remove('show');
        document.getElementById('result-content').classList.remove('hidden');
      }, 1500);
    }

    function buildCommentPaper(lecture, resume, level, dept) {
      // Extract keywords from resume
      const keywords = extractKeywords(resume);
      const mainTopic = keywords[0] || lecture;
      const subTopic = keywords[1] || '';

      // Determine style parameters
      const ending = getEndingStyle();
      const connector = getConnectors(level);

      let output = '';

      switch (level) {
        case 1: // 10% - ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«
          output = generate10(lecture, mainTopic, subTopic, ending, keywords);
          break;
        case 2: // 30% - é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«
          output = generate30(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
        case 3: // 50% - å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰
          output = generate50(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
        case 4: // 70% - å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰
          output = generate70(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
        case 5: // 90% - å¤§å­¦é™¢ãƒ»è«–æ–‡ãƒ¬ãƒ™ãƒ«
          output = generate90(lecture, mainTopic, subTopic, ending, connector, keywords);
          break;
      }

      // Apply department tone
      output = applyDeptTone(output, dept);

      // Remove banned words
      BANNED_WORDS.forEach(w => {
        output = output.replaceAll(w, '');
      });

      // Clean up double spaces and line breaks
      output = output.replace(/\n{3,}/g, '\n\n').trim();

      return output;
    }

    function extractKeywords(text) {
      // Japanese text has no natural word boundaries, so we use pattern matching
      // to extract noun-like compound phrases

      const freq = {};

      // 1. Extract katakana compound words (e.g. ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢, ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ–ãƒ«, ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
      const katakanaMatches = text.match(/[\u30A1-\u30F6ãƒ¼]{3,}/g) || [];
      katakanaMatches.forEach(w => { freq[w] = (freq[w] || 0) + 1; });

      // 2. Extract kanji compound words (e.g. å…¬å…±åœ, æƒ…å ±é¸åˆ¥, æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼)
      const kanjiMatches = text.match(/[\u4E00-\u9FFF]{2,6}/g) || [];
      const kanjiStopWords = new Set([
        'æœ¬è¬›ç¾©', 'å—è¬›è€…', 'è€ƒå¯Ÿ', 'è­°è«–', 'ç›®æŒ‡', 'å¤‰åŒ–', 'è‡ªèº«',
        'æ‰¹åˆ¤çš„', 'ç‰¹ã«', 'è¬›ç¾©', 'å½¢æ…‹', 'æŒ¯ã‚Šè¿”', 'ä»¥ä¸‹', 'ä¸Šè¨˜',
        'å ´åˆ', 'å¿…è¦', 'é‡è¦', 'ç†è§£', 'å­¦ç¿’', 'å‘ä¸Š', 'åˆ©ç”¨'
      ]);
      kanjiMatches.forEach(w => {
        if (kanjiStopWords.has(w)) return;
        freq[w] = (freq[w] || 0) + 1;
      });

      // 3. Extract mixed kanji+katakana/hiragana noun phrases
      //    e.g. "æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼", "ãƒ¡ãƒ‡ã‚£ã‚¢åˆ©ç”¨", "å…¬å…±åœã®å¤‰å®¹"
      const mixedPatterns = [
        /[\u4E00-\u9FFF]{1,4}[\u30A1-\u30F6ãƒ¼]{2,}/g,     // kanji+katakana
        /[\u30A1-\u30F6ãƒ¼]{2,}[\u4E00-\u9FFF]{1,4}/g,     // katakana+kanji
        /([\u4E00-\u9FFF\u30A1-\u30F6ãƒ¼]{2,})ã®([\u4E00-\u9FFF\u30A1-\u30F6ãƒ¼]{2,})/g  // Xã® Y patterns
      ];
      mixedPatterns.forEach(pat => {
        let match;
        const regex = new RegExp(pat.source, pat.flags);
        while ((match = regex.exec(text)) !== null) {
          const phrase = match[0];
          if (phrase.length >= 3 && phrase.length <= 15) {
            freq[phrase] = (freq[phrase] || 0) + 1;
          }
        }
      });

      // Exclude banned-like terms and very generic words
      const excludeTerms = new Set([
        'æœ¬è¬›ç¾©', 'å—è¬›è€…', 'è¬›ç¾©ã§ã¯', 'æœ¬è¬›ç¾©ã§ã¯', 'ã«ã¤ã„ã¦', 'ã«ãŠã‘ã‚‹'
      ]);

      return Object.entries(freq)
        .filter(([k]) => !excludeTerms.has(k) && k.length >= 2)
        .sort((a, b) => {
          // Prefer longer, more specific terms, then by frequency
          const lenDiff = Math.min(b[0].length, 8) - Math.min(a[0].length, 8);
          if (lenDiff !== 0) return lenDiff;
          return b[1] - a[1];
        })
        .slice(0, 8)
        .map(e => e[0]);
    }

    function getEndingStyle() {
      if (styleData) {
        if (styleData.styleType === 'ã ãƒ»ã§ã‚ã‚‹èª¿') return 'da';
        if (styleData.styleType === 'ã§ã™ãƒ»ã¾ã™èª¿') return 'desu';
        return 'mixed';
      }
      return 'desu'; // default
    }

    function e(type, variations) {
      // Return ending based on style type
      const v = variations[type] || variations['desu'];
      return Array.isArray(v) ? v[Math.floor(Math.random() * v.length)] : v;
    }

    function getConnectors(level) {
      if (level <= 2) return ['ã‚ã¨', 'ãã‚Œã¨', 'ã§ã‚‚', 'ã‚ã¨æ°—ã«ãªã£ãŸã®ã¯'];
      if (level <= 3) return ['ã¾ãŸ', 'ã—ã‹ã—', 'ä¸€æ–¹ã§', 'ã•ã‚‰ã«'];
      return ['åŠ ãˆã¦', 'ãã®ä¸€æ–¹ã§', 'ã“ã“ã§æ³¨ç›®ã™ã¹ãã¯', 'ã•ã‚‰ã«è¸ã¿è¾¼ã‚€ã¨'];
    }

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    /* ============================================
       LEVEL GENERATORS
       ============================================ */
    function generate10(lecture, main, sub, ending, kw) {
      // ä¸­å­¦ç”Ÿãƒ¬ãƒ™ãƒ«: éå¸¸ã«å¹³æ˜“ãªè¨€è‘‰ã€æ„Ÿæƒ³8å‰²ã€ã€Œã™ã”ã‹ã£ãŸã€ã€Œæ€ã£ãŸã€
      const openers = [
        `ä»Šæ—¥ã®${lecture}ã§${main}ã®è©±ã‚’èã„${e(ending, { da: 'ãŸ', desu: 'ãŸ', mixed: 'ãŸ' })}ã€‚`,
        `${lecture}ã®æˆæ¥­ãŒã‚${e(ending, { da: 'ã£ãŸ', desu: 'ã‚Šã¾ã—ãŸ', mixed: 'ã£ãŸ' })}ã€‚`,
      ];
      const impressions = [
        `${main}ã®è©±${e(ending, { da: 'ãŒã™ã”ã‹ã£ãŸ', desu: 'ãŒã™ã”ã‹ã£ãŸã§ã™', mixed: 'ãŒã™ã”ã„ã¨æ€ã£ãŸ' })}ã€‚`,
        `${main}${e(ending, { da: 'ãŒã‘ã£ã“ã†é¢ç™½ã‹ã£ãŸ', desu: 'ãŒã‘ã£ã“ã†é¢ç™½ã‹ã£ãŸã§ã™', mixed: 'ãŒã‘ã£ã“ã†é¢ç™½ã„ãªã¨æ€ã£ãŸ' })}ã€‚`,
      ];
      const sub_part = sub ? `${sub}ã®è©±${e(ending, { da: 'ã‚‚æ°—ã«ãªã£ãŸ', desu: 'ã‚‚æ°—ã«ãªã‚Šã¾ã—ãŸ', mixed: 'ã‚‚æ°—ã«ãªã£ãŸ' })}ã€‚` : '';
      const closing = `${e(ending, {
        da: 'ã¾ã ã‚ˆãã‚ã‹ã‚‰ãªã„ã¨ã“ã‚ã‚‚ã‚ã£ãŸã‘ã©ã€',
        desu: 'ã¾ã ã‚ˆãã‚ã‹ã‚‰ãªã„ã¨ã“ã‚ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€',
        mixed: 'ã¾ã ã‚ˆãã‚ã‹ã‚‰ãªã„ã¨ã“ã‚ã‚‚ã‚ã£ãŸã‘ã©ã€'
      })}${main}ã®ã“ã¨${e(ending, {
        da: 'ã‚’ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã¨æ€ã£ãŸ',
        desu: 'ã‚’ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ãªã¨æ€ã„ã¾ã—ãŸ',
        mixed: 'ã‚’ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ãªã¨æ€ã£ãŸ'
      })}ã€‚`;
      return [pickRandom(openers), pickRandom(impressions), sub_part, closing].filter(s => s).join('');
    }

    function generate30(lecture, main, sub, ending, conn, kw) {
      // é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«: èªå½™ã‚„ã‚„åºƒã‚ã€å°‚é–€ç”¨èªã¯é¿ã‘ã‚‹ã€è‡ªåˆ†ã®ä½“é¨“ã‚’æ··ãœãŸä¸å¯§ãªæ„Ÿæƒ³æ–‡
      const intro = `${lecture}ã®æˆæ¥­ã§${main}ã«ã¤ã„ã¦å­¦ã‚“${e(ending, { da: 'ã ', desu: 'ã³ã¾ã—ãŸ', mixed: 'ã ' })}ã€‚`;
      const experience = `${main}ã«ã¤ã„ã¦ã¯ã€${e(ending, {
        da: 'è‡ªåˆ†ã®æ™®æ®µã®ç”Ÿæ´»ã§ã¯ã‚ã¾ã‚Šæ„è­˜ã—ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã€æ–°ã—ã„ç™ºè¦‹ã ã£ãŸ',
        desu: 'æ™®æ®µã®ç”Ÿæ´»ã§ã¯ã‚ã¾ã‚Šæ„è­˜ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€æ–°ã—ã„ç™ºè¦‹ã§ã—ãŸ',
        mixed: 'è‡ªåˆ†ã®æ—¥å¸¸ã§ã¯ã‚ã¾ã‚Šæ„è­˜ã—ã¦ã“ãªã‹ã£ãŸã®ã§ã€æ–°é®®ã«æ„Ÿã˜ãŸ'
      })}ã€‚`;
      const sub_part = sub ? `${pickRandom(conn)}ã€${sub}ã«ã¤ã„ã¦ã‚‚è§¦ã‚Œã‚‰ã‚Œã¦ã„ã¦ã€${e(ending, {
        da: 'èº«è¿‘ãªä¾‹ã‚’æ€ã„æµ®ã‹ã¹ãªãŒã‚‰èãã“ã¨ãŒã§ããŸ',
        desu: 'èº«è¿‘ãªä¾‹ã¨çµã³ã¤ã‘ãªãŒã‚‰èãã“ã¨ãŒã§ãã¾ã—ãŸ',
        mixed: 'è‡ªåˆ†ãªã‚Šã«èº«è¿‘ãªä¾‹ã¨çµã³ã¤ã‘ãªãŒã‚‰èã‘ãŸ'
      })}ã€‚` : '';
      const closing = `${e(ending, {
        da: 'ã‚‚ã†å°‘ã—æ·±ãçŸ¥ã‚ŠãŸã„ã¨æ„Ÿã˜ãŸã®ã§ã€æ¬¡å›ã®æˆæ¥­ã‚‚æ¥½ã—ã¿ã ',
        desu: 'ã‚‚ã†å°‘ã—æ·±ãçŸ¥ã‚ŠãŸã„ã¨æ„Ÿã˜ãŸã®ã§ã€æ¬¡å›ã®æˆæ¥­ã‚‚æ¥½ã—ã¿ã§ã™',
        mixed: 'ã‚‚ã†å°‘ã—è©³ã—ãçŸ¥ã‚ŠãŸã„ãªã¨æ€ã£ãŸã®ã§ã€æ¬¡å›ã®æˆæ¥­ã‚‚æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹'
      })}ã€‚`;
      return [intro, experience, sub_part, closing].filter(s => s).join('');
    }

    function generate50(lecture, main, sub, ending, conn, kw) {
      // å¤§å­¦ç”Ÿï¼ˆæ¨™æº–ï¼‰: äº‹å®Ÿã¨è€ƒå¯Ÿ5:5ã€è«–ç†çš„æ¥ç¶šè©ã€ç­‰èº«å¤§ã®è¦–ç‚¹
      const fact = `ä»Šå›ã®${lecture}ã§ã¯ã€${main}ã«ã¤ã„ã¦å–ã‚Šä¸Šã’ã‚‰ã‚Œ${e(ending, { da: 'ãŸ', desu: 'ã¾ã—ãŸ', mixed: 'ãŸ' })}ã€‚`;
      const insight = `${pickRandom(conn)}ã€${main}ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã‚‹ã¨ã€${e(ending, {
        da: 'è‡ªåˆ†ãŒã“ã‚Œã¾ã§æ¼ ç„¶ã¨æŒã£ã¦ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã¯å°‘ã—ç•°ãªã‚‹å´é¢ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ã„ãŸ',
        desu: 'è‡ªåˆ†ãŒã“ã‚Œã¾ã§ä½•ã¨ãªãæŒã£ã¦ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã¯ç•°ãªã‚‹å´é¢ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸ',
        mixed: 'è‡ªåˆ†ã®ä¸­ã«ã‚ã£ãŸæ¼ ç„¶ã¨ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã¯é•ã†é¢ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ã„ãŸ'
      })}ã€‚`;
      const sub_part = sub ? `${pickRandom(conn)}ã€${sub}ã¨ã®é–¢é€£ã§ã„ãˆã°ã€${e(ending, {
        da: 'ä¸¡è€…ã®ã¤ãªãŒã‚Šã‚’æ„è­˜ã—ãªãŒã‚‰èãã¨ã€ã‚ˆã‚Šç†è§£ãŒæ·±ã¾ã£ãŸã‚ˆã†ã«æ€ã†',
        desu: 'ä¸¡è€…ã®ã¤ãªãŒã‚Šã‚’æ„è­˜ã—ãªãŒã‚‰èãã“ã¨ã§ã€ç†è§£ãŒæ·±ã¾ã£ãŸã‚ˆã†ã«æ„Ÿã˜ã¾ã™',
        mixed: 'ä¸¡è€…ã®ã¤ãªãŒã‚Šã‚’æ„è­˜ã™ã‚‹ã¨ã€ã‚ˆã‚Šç†è§£ã—ã‚„ã™ããªã£ãŸã‚ˆã†ã«æ„Ÿã˜ãŸ'
      })}ã€‚` : '';
      const reflection = `è¬›ç¾©ä¸­ã«ãƒ¡ãƒ¢ã—ãŸ${kw[2] || main}ã¨ã„ã†${e(ending, {
        da: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå°è±¡ã«æ®‹ã£ã¦ã„ã‚‹',
        desu: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç‰¹ã«å°è±¡ã«æ®‹ã£ã¦ã„ã¾ã™',
        mixed: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå°è±¡ã«æ®‹ã£ãŸ'
      })}ã€‚`;
      const closing = `${e(ending, {
        da: 'ã¾ã è‡ªåˆ†ã®ä¸­ã§æ•´ç†ã—ãã‚Œã¦ã„ãªã„éƒ¨åˆ†ã‚‚ã‚ã‚‹ãŒã€æ¬¡å›ã®è¬›ç¾©ã§ç†è§£ã‚’è£œã„ãŸã„',
        desu: 'ã¾ã è‡ªåˆ†ã®ä¸­ã§æ•´ç†ã—ãã‚Œã¦ã„ãªã„éƒ¨åˆ†ã‚‚ã‚ã‚Šã¾ã™ãŒã€æ¬¡å›ã®è¬›ç¾©ã§ç†è§£ã‚’è£œã„ãŸã„ã§ã™',
        mixed: 'ã¾ã å®Œå…¨ã«ã¯æ¶ˆåŒ–ã—ãã‚Œã¦ã„ãªã„éƒ¨åˆ†ã‚‚ã‚ã‚‹ãŒã€å¼•ãç¶šãè€ƒãˆã¦ã„ããŸã„ã¨æ€ã£ãŸ'
      })}ã€‚`;
      return [fact, insight, sub_part, reflection, closing].filter(s => s).join('');
    }

    function generate70(lecture, main, sub, ending, conn, kw) {
      // å¤§å­¦ç”Ÿï¼ˆçœŸé¢ç›®ï¼‰: è¬›ç¾©å†…å®¹ã‚’æ·±ãå’€åš¼ã€å°‚é–€ç”¨èªã‚’é©åˆ‡ã«ä½¿ç”¨ã€æ‰¹åˆ¤çš„è¦–ç‚¹10%
      const intro = `${lecture}ã«ãŠã„ã¦${main}ãŒå–ã‚Šä¸Šã’ã‚‰ã‚Œ${e(ending, { da: 'ãŸ', desu: 'ã¾ã—ãŸ', mixed: 'ãŸ' })}ã€‚`;
      const analysis = `${main}ã‚’ã‚ãã‚‹è­°è«–ã‚’é€šã˜ã¦ã€${e(ending, {
        da: 'å¾“æ¥ã®æ çµ„ã¿ã§ã¯ååˆ†ã«èª¬æ˜ã—ãã‚Œãªã„å´é¢ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ãŒæ˜ã‚‰ã‹ã«ãªã£ãŸ',
        desu: 'å¾“æ¥ã®æ çµ„ã¿ã ã‘ã§ã¯ååˆ†ã«èª¬æ˜ã—ãã‚Œãªã„å´é¢ãŒã‚ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã¾ã—ãŸ',
        mixed: 'å¾“æ¥ã®æ çµ„ã¿ã§ã¯æ‰ãˆãã‚Œãªã„éƒ¨åˆ†ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ã‹ã•ã‚ŒãŸã‚ˆã†ã«æ€ã†'
      })}ã€‚`;
      const deep = `${pickRandom(conn)}ã€${sub || kw[1] || main}ã¨ã®é–¢é€£æ€§ã‚’è¸ã¾ãˆ${e(ending, {
        da: 'ã‚‹ã¨ã€ã“ã®å•é¡Œã¯è¤‡åˆçš„ãªè¦–ç‚¹ã‹ã‚‰ã®åˆ†æãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ãƒ†ãƒ¼ãƒã§ã‚ã‚Šã€å˜ä¸€ã®ç†è«–ã§ç‰‡ã¥ã‘ã‚‹ã¹ãã§ã¯ãªã„ã¨è€ƒãˆã‚‹',
        desu: 'ã‚‹ã¨ã€ã“ã®ãƒ†ãƒ¼ãƒã¯è¤‡æ•°ã®è§’åº¦ã‹ã‚‰æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä¸€ã¤ã®ç†è«–ã ã‘ã§ã¯ååˆ†ã«èª¬æ˜ã§ããªã„ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™',
        mixed: 'ã¦ã¿ã‚‹ã¨ã€ä¸€ã¤ã®è¦–ç‚¹ã ã‘ã§ã¯ä¸ååˆ†ã§ã‚ã‚Šã€è¤‡åˆçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¿…è¦ãªãƒ†ãƒ¼ãƒã ã¨æ„Ÿã˜ãŸ'
      })}ã€‚`;
      const critical = `ãŸã ã—ã€${e(ending, {
        da: 'è¬›ç¾©ã§æç¤ºã•ã‚ŒãŸè¦‹è§£ã«ã‚‚æ¤œè¨ã®ä½™åœ°ã¯ã‚ã‚Šã€ç‰¹ã«${kw[2] || main}ã«ã¤ã„ã¦ã¯ç•°ãªã‚‹ç«‹å ´ã‹ã‚‰ã®åè«–ã‚‚æƒ³å®šã—ã†ã‚‹ã€‚ã“ã®ç‚¹ã¯è‡ªåˆ†ãªã‚Šã«ã•ã‚‰ã«è€ƒãˆã¦ã„ããŸã„',
        desu: 'è¬›ç¾©ã§æç¤ºã•ã‚ŒãŸè¦‹è§£ã«ã‚‚ã¾ã æ¤œè¨ã®ä½™åœ°ãŒã‚ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã¾ã—ãŸã€‚ç‰¹ã«${kw[2] || main}ã«ã¤ã„ã¦ã¯ã€ç•°ãªã‚‹ç«‹å ´ã‹ã‚‰ã‚‚è€ƒãˆã¦ã¿ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™',
        mixed: 'è¬›ç¾©ã®è¦‹è§£ã«ã‚‚ç–‘å•ãŒæ®‹ã‚‹éƒ¨åˆ†ã¯ã‚ã‚Šã€ç‰¹ã«${kw[2] || main}ã«ã¤ã„ã¦ã¯åˆ¥ã®è§’åº¦ã‹ã‚‰ã‚‚è€ƒãˆã‚‹ä½™åœ°ãŒã‚ã‚Šãã†ã '
      })}ã€‚`;
      const closing = `ä»Šå¾Œã¯ã€${main}${e(ending, {
        da: 'ã‚’ä»–ã®ç†è«–çš„æ–‡è„ˆã«ã‚‚ä½ç½®ã¥ã‘ãªãŒã‚‰ã€è‡ªåˆ†ãªã‚Šã®ç†è§£ã‚’æ§‹ç¯‰ã—ã¦ã„ããŸã„',
        desu: 'ã‚’ä»–ã®ç†è«–ã¨çµã³ã¤ã‘ãªãŒã‚‰ã€è‡ªåˆ†ãªã‚Šã®ç†è§£ã‚’æ·±ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™',
        mixed: 'ã«ã¤ã„ã¦ã€ä»–ã®æ–‡è„ˆã¨ã‚‚é–¢é€£ã¥ã‘ãªãŒã‚‰è‡ªåˆ†ã®è€ƒãˆã‚’æ·±ã‚ã¦ã„ããŸã„'
      })}ã€‚`;
      return [intro, analysis, deep, critical, closing].join('');
    }

    function generate90(lecture, main, sub, ending, conn, kw) {
      // å¤§å­¦é™¢ãƒ»è«–æ–‡ãƒ¬ãƒ™ãƒ«: æ¥µã‚ã¦è«–ç†çš„ã§ç¡¬ã„æ–‡ä½“ã€å…ˆè¡Œç ”ç©¶ã‚„æ¦‚å¿µã®å®šç¾©ã«è§¦ã‚Œã‚‹ã€å­¦è¡“çš„æ‰‹ç¶šã
      const intro = `${lecture}ã«ãŠã„ã¦æç¤ºã•ã‚ŒãŸ${main}ã«é–¢ã™ã‚‹è­°è«–${e(ending, {
        da: 'ã¯ã€å½“è©²åˆ†é‡ã«ãŠã‘ã‚‹ä¸­å¿ƒçš„ãªå•ã„ã‚’å†è€ƒã™ã‚‹å¥‘æ©Ÿã‚’ä¸ãˆã‚‹ã‚‚ã®ã§ã‚ã£ãŸ',
        desu: 'ã¯ã€ã“ã®åˆ†é‡ã®æ ¹å¹¹ã«é–¢ã‚ã‚‹å•ã„ã‚’æ”¹ã‚ã¦è€ƒãˆã•ã›ã‚‰ã‚Œã‚‹ã‚‚ã®ã§ã—ãŸ',
        mixed: 'ã¯ã€ã“ã®åˆ†é‡ã«ãŠã‘ã‚‹æ ¹æœ¬çš„ãªå•ã„ã‚’è€ƒãˆç›´ã™ãã£ã‹ã‘ã«ãªã£ãŸã¨æ€ã†'
      })}ã€‚`;
      const definition = `ã¾ãšã€${main}ã®æ¦‚å¿µã‚’æ•´ç†ã™ã‚‹ã¨ã€${e(ending, {
        da: 'å…ˆè¡Œç ”ç©¶ã«ãŠã„ã¦ã¯è¤‡æ•°ã®å®šç¾©ãŒä¸¦ç«‹ã—ã¦ãŠã‚Šã€ãã®å°„ç¨‹ã¯è«–è€…ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã€‚è¬›ç¾©ã§ã¯ã“ã®å¤šç¾©æ€§ã‚’è¸ã¾ãˆãŸä¸Šã§è­°è«–ãŒå±•é–‹ã•ã‚Œã¦ã„ãŸç‚¹ãŒé‡è¦ã§ã‚ã‚‹',
        desu: 'å…ˆè¡Œç ”ç©¶ã§ã¯è¤‡æ•°ã®å®šç¾©ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€ãã®æ„å‘³ã™ã‚‹ç¯„å›²ã¯ç ”ç©¶è€…ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚è¬›ç¾©ã§ã¯ã“ã®å¤šç¾©æ€§ã‚’å‰æã¨ã—ãŸã†ãˆã§è­°è«–ãŒå±•é–‹ã•ã‚Œã¦ã„ãŸç‚¹ãŒé‡è¦ã ã¨æ„Ÿã˜ã¾ã—ãŸ',
        mixed: 'å…ˆè¡Œç ”ç©¶ã§ã¯è¤‡æ•°ã®å®šç¾©ãŒä¸¦å­˜ã—ã¦ãŠã‚Šã€ãã®ç¯„å›²ã¯è«–è€…ã«ã‚ˆã‚Šç•°ãªã‚‹ã€‚è¬›ç¾©ã§ã¯ã“ã®å¤šç¾©æ€§ã‚’è¸ã¾ãˆã¦è­°è«–ãŒå±•é–‹ã•ã‚Œã¦ã„ãŸç‚¹ãŒæ³¨ç›®ã«å€¤ã™ã‚‹'
      })}ã€‚`;
      const theory = `${pickRandom(conn)}ã€${main}ã‚’${sub || 'æ—¢å­˜ã®ç†è«–'}ã¨å¯¾ç…§ã•ã›${e(ending, {
        da: 'ã‚‹ã¨ã€æ–¹æ³•è«–ä¸Šã®æ–­çµ¶ã®ã¿ãªã‚‰ãšã€èªè­˜è«–çš„ãªå‰æã®å·®ç•°ãŒæ¨ªãŸã‚ã£ã¦ã„ã‚‹ã“ã¨ãŒçœ‹å–ã•ã‚Œã‚‹ã€‚ã“ã®è«–ç‚¹ã¯å¾“æ¥ã®ç ”ç©¶ã§ã¯ç­‰é–‘è¦–ã•ã‚Œã¦ããŸèª²é¡Œã§ã‚‚ã‚ã‚‹',
        desu: 'ã¦ã¿ã‚‹ã¨ã€æ–¹æ³•è«–çš„ãªé•ã„ã ã‘ã§ãªãã€èªè­˜è«–çš„ãªå‰æã«ã‚‚å·®ç•°ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®ç‚¹ã¯ã€å…ˆè¡Œç ”ç©¶ã®ä¸­ã§ã‚‚ã¾ã ååˆ†ã«è­°è«–ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã«æ€ã„ã¾ã™',
        mixed: 'ã¦ã¿ã‚‹ã¨ã€æ–¹æ³•è«–ä¸Šã®ç›¸é•ã ã‘ã§ãªãã€èªè­˜ã®å‰æãã®ã‚‚ã®ã«é½Ÿé½¬ãŒã‚ã‚‹ã“ã¨ãŒè¦‹ãˆã¦ãã‚‹ã€‚ã“ã®ã‚ãŸã‚Šã¯å…ˆè¡Œç ”ç©¶ã§ã‚‚ååˆ†ã«è«–ã˜ã‚‰ã‚Œã¦ã“ãªã‹ã£ãŸèª²é¡Œã ã‚ã†'
      })}ã€‚`;
      const closing = `ä»Šå¾Œã®ç ”ç©¶ã«ãŠã„ã¦ã¯ã€${main}${e(ending, {
        da: 'ã‚’ã‚ãã‚‹ç†è«–çš„ç³»è­œã‚’è¾¿ã‚Šã¤ã¤ã€å®Ÿè¨¼çš„ãƒ‡ãƒ¼ã‚¿ã¨ã®ç…§åˆã‚’é€šã˜ã¦è€ƒå¯Ÿã‚’ç²¾ç·»åŒ–ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã€‚æœ¬è¬›ç¾©ã¯ãã®ãŸã‚ã®é‡è¦ãªç«¯ç·’ã‚’æä¾›ã—ãŸ',
        desu: 'ã«é–¢ã™ã‚‹ç†è«–ã®å¤‰é·ã‚’è¿½ã„ãªãŒã‚‰ã€å…·ä½“çš„ãªäº‹ä¾‹ã¨ã®æ¯”è¼ƒã‚’é€šã˜ã¦è€ƒå¯Ÿã‚’æ·±ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™',
        mixed: 'ã®ç†è«–çš„ãªæµã‚Œã‚’è¾¿ã‚Šã¤ã¤ã€å®Ÿè¨¼çš„ãªãƒ‡ãƒ¼ã‚¿ã¨ã®çªåˆã›ã‚’é€šã˜ã¦ç†è§£ã‚’ç²¾ç·»åŒ–ã—ã¦ã„ããŸã„ã¨è€ƒãˆã¦ã„ã‚‹'
      })}ã€‚`;
      return [intro, definition, theory, closing].join('');
    }

    /* ============================================
       DEPARTMENT TONE
       ============================================ */
    function applyDeptTone(text, dept) {
      switch (dept) {
        case 'science-eng':
          // ç†ç³»ãƒ»å·¥å­¦éƒ¨: ãƒ‡ãƒ¼ã‚¿ãƒ»è«–ç†é‡è¦–ã€æ„Ÿæƒ…èªã‚’æŠ‘åˆ¶
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'èˆˆå‘³æ·±ã„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã ã£ãŸ')
            .replace(/é¢ç™½ã„/g, 'åˆç†çš„ãªæ§‹é€ ã‚’æŒã¤')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®åŠ¹ç‡æ€§ã«ã¤ã„ã¦æ¤œè¨ã®ä½™åœ°ãŒã‚ã‚‹')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'ãƒ‡ãƒ¼ã‚¿ãŒç¤ºã™å‚¾å‘ã‹ã‚‰èª­ã¿å–ã‚‹ã“ã¨ãŒã§ããŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'å®šé‡çš„ãªè¦³ç‚¹ã‹ã‚‰æ³¨ç›®ã«å€¤ã™')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®è§£æ˜ã«å‘ã‘ã¦åˆ†æã‚’é€²ã‚ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚„æ•°å€¤çš„æ ¹æ‹ ');
          break;
        case 'social-psych':
          // ç¤¾ä¼šãƒ»å¿ƒç†å­¦éƒ¨: äººé–“è¡Œå‹•ãƒ»ç¤¾ä¼šæ§‹é€ ã®è¦–ç‚¹
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'ç¤¾ä¼šçš„èƒŒæ™¯ã‚’è€ƒãˆã‚‹ã¨ç¤ºå”†çš„ã ã£ãŸ')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®å¿ƒç†çš„è¦å› ã«ã¤ã„ã¦ã•ã‚‰ã«è€ƒå¯Ÿã—ãŸã„')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'äººé–“ã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã„ã†è¦³ç‚¹ã‹ã‚‰æ–°ãŸãªæ°—ã¥ãã‚’å¾—ãŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'ç¤¾ä¼šæ§‹é€ ã¨ã®é–¢é€£ã§è€ƒãˆã‚‹ã¨å°è±¡çš„ã§ã‚')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'ç¤¾ä¼šçš„ãƒ»å¿ƒç†çš„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã‚’é€²ã‚ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚„èª¿æŸ»ãƒ‡ãƒ¼ã‚¿');
          break;
        case 'econ-biz':
          // çµŒæ¸ˆãƒ»çµŒå–¶å­¦éƒ¨: ã‚³ã‚¹ãƒˆãƒ»å¸‚å ´ãƒ»åŠ¹ç‡ãƒ»ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'å®Ÿç”¨æ€§ã®è¦³ç‚¹ã‹ã‚‰æœ‰ç›Šã ã£ãŸ')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®è²»ç”¨å¯¾åŠ¹æœã‚„å¸‚å ´ã¸ã®å½±éŸ¿ã‚’æ¤œè¨ã—ãŸã„')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–æ§‹é€ ã®é¢ã‹ã‚‰å†èªè­˜ã•ã›ã‚‰ã‚ŒãŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'çµŒæ¸ˆçš„åˆç†æ€§ã®è¦³ç‚¹ã‹ã‚‰æ³¨ç›®ã™ã¹ãã§ã‚')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'å¸‚å ´ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨åŠ¹ç‡æ€§ã®åˆ†æã‚’é€²ã‚ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚„ä¼æ¥­äº‹ä¾‹');
          break;
        case 'literature-phil':
          // æ–‡å­¦ãƒ»å“²å­¦éƒ¨: èªå½™è±Šã‹ã€æŠ½è±¡çš„ãƒ»æ€ç´¢çš„
          text = text
            .replace(/é¢ç™½ã‹ã£ãŸ/g, 'æ·±ã„ç¤ºå”†ã‚’å«ã‚“ã§ã„ãŸ')
            .replace(/æ°—ã«ãªã£ãŸ/g, 'ãã®æ ¹åº•ã«ã‚ã‚‹æ€æƒ³ã«ã¤ã„ã¦æ€ç´¢ã‚’å·¡ã‚‰ã›ãŸã„')
            .replace(/æ°—ã¥ã‹ã•ã‚ŒãŸ/g, 'æ¦‚å¿µã®å†å®šç¾©ã‚’è¿«ã‚‰ã‚Œã‚‹ã‚ˆã†ãªçŸ¥çš„åˆºæ¿€ã‚’å—ã‘ãŸ')
            .replace(/å°è±¡ã«æ®‹/g, 'è¨€è‘‰ã®å¤šå±¤çš„ãªæ„å‘³åˆã„ã¨ã—ã¦å°è±¡æ·±ãã‚')
            .replace(/ç†è§£ã‚’æ·±ã‚ã¦/g, 'ãƒ†ã‚¯ã‚¹ãƒˆã®èª­ã¿ã‚’æ·±ã‚ã€æ€ç´¢ã®å°„ç¨‹ã‚’åºƒã’ã¦')
            .replace(/å…·ä½“çš„ãªäº‹ä¾‹/g, 'æ–‡å­¦ä½œå“ã‚„å“²å­¦çš„ãƒ†ã‚¯ã‚¹ãƒˆ');
          break;
      }
      return text;
    }

    /* ============================================
       COPY TO CLIPBOARD
       ============================================ */
    function copyResult() {
      const text = document.getElementById('result-text').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const feedback = document.getElementById('copy-feedback');
        feedback.classList.add('show');
        setTimeout(() => feedback.classList.remove('show'), 2500);
      });
    }
  </script>
</body>

</html>
